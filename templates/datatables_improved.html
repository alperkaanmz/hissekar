{% extends 'components/base.html' %}
{% load static %}

{% block styles %}
<style>
    .modern-table-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin: 20px 0;
    }
    
    .table-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        text-align: center;
    }
    
    .table-header h2 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 600;
    }
    
    .table-header p {
        margin: 10px 0 0 0;
        opacity: 0.9;
        font-size: 1rem;
    }
    
    .filter-section {
        padding: 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
    }
    
    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: center;
    }
    
    .filter-input {
        padding: 10px 15px;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        font-size: 14px;
        transition: all 0.3s ease;
    }
    
    .filter-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .download-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .download-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
    }
    
    .modern-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .modern-table thead {
        background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
        color: white;
    }
    
    .modern-table th {
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .modern-table td {
        padding: 12px;
        border-bottom: 1px solid #e9ecef;
        font-size: 14px;
        vertical-align: middle;
    }
    
    .modern-table tbody tr {
        transition: all 0.3s ease;
    }
    
    .modern-table tbody tr:hover {
        background-color: #f8f9fa;
        transform: scale(1.002);
    }
    
    .symbol-cell {
        font-weight: bold;
        color: #667eea;
        cursor: pointer;
        text-decoration: underline;
    }
    
    .symbol-cell:hover {
        color: #764ba2;
    }
    
    .positive {
        color: #28a745;
        font-weight: 600;
    }
    
    .negative {
        color: #dc3545;
        font-weight: 600;
    }
    
    .neutral {
        color: #6c757d;
        font-weight: 600;
    }
    
    .pagination {
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
    }
    
    .pagination button {
        padding: 8px 12px;
        border: 2px solid #e9ecef;
        background: white;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .pagination button:hover {
        border-color: #667eea;
        background: #667eea;
        color: white;
    }
    
    .pagination button.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    @media (max-width: 768px) {
        .filter-grid {
            grid-template-columns: 1fr;
        }
        
        .download-buttons {
            justify-content: center;
        }
        
        .modern-table {
            font-size: 12px;
        }
        
        .modern-table th,
        .modern-table td {
            padding: 8px;
        }
        
        .table-header h2 {
            font-size: 1.4rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content">
    <!-- Page Header -->
    <div class="block justify-between page-header md:flex">
        <div>
            <h3 class="!text-defaulttextcolor dark:!text-defaulttextcolor/70 dark:text-white dark:hover:text-white text-[1.125rem] font-semibold">
                Financial Data Tables
            </h3>
        </div>
        <ol class="flex items-center whitespace-nowrap min-w-0">
            <li class="text-[0.813rem] ps-[0.5rem]">
                <a class="flex items-center text-primary hover:text-primary dark:text-primary truncate" href="javascript:void(0);">
                    Data
                    <i class="ti ti-chevrons-right flex-shrink-0 text-[#8c9097] dark:text-white/50 px-[0.5rem] overflow-visible rtl:rotate-180"></i>
                </a>
            </li>
            <li class="text-[0.813rem] text-defaulttextcolor font-semibold hover:text-primary dark:text-[#8c9097] dark:text-white/50" aria-current="page">
                Tables
            </li>
        </ol>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total Companies</div>
            <div class="stat-number" id="total-companies">{{companies|length}}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Sectors</div>
            <div class="stat-number" id="total-sectors">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Market Cap (Avg)</div>
            <div class="stat-number" id="avg-market-cap">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">P/E Ratio (Avg)</div>
            <div class="stat-number" id="avg-pe">-</div>
        </div>
    </div>

    <!-- Modern Table Container -->
    <div class="modern-table-container">
        <div class="table-header">
            <h2>Turkish Stock Market Analysis</h2>
            <p>Real-time financial data and performance metrics</p>
        </div>
        
        <div class="filter-section">
            <div class="filter-grid">
                <input type="text" id="search-input" class="filter-input" placeholder="üîç Search companies...">
                <select id="sector-filter" class="filter-input">
                    <option value="">All Sectors</option>
                </select>
                <select id="sort-select" class="filter-input">
                    <option value="symbol">Sort by Symbol</option>
                    <option value="marketCap">Sort by Market Cap</option>
                    <option value="pe">Sort by P/E Ratio</option>
                    <option value="volume">Sort by Volume</option>
                </select>
                <div class="download-buttons">
                    <button class="download-btn" onclick="downloadCSV()">
                        üìÑ CSV
                    </button>
                    <button class="download-btn" onclick="downloadJSON()">
                        üìã JSON
                    </button>
                    <button class="download-btn" onclick="printTable()">
                        üñ®Ô∏è Print
                    </button>
                </div>
            </div>
        </div>
        
        <div class="table-wrapper">
            <table class="modern-table" id="financialTable">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Company Name</th>
                        <th>Market Cap</th>
                        <th>P/E Ratio</th>
                        <th>Volume</th>
                        <th>52W High</th>
                        <th>52W Low</th>
                        <th>Sector</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    {% for company in companies %}
                    <tr data-symbol="{{company.symbol}}" data-sector="{{company.sector|default:'N/A'}}">
                        <td class="symbol-cell" onclick="viewProfile('{{company.symbol}}')">{{company.symbol}}</td>
                        <td>{{company.name}}</td>
                        <td class="market-cap">{{company.market_cap|default:'-'}}</td>
                        <td class="pe-ratio">{{company.pe_ratio|default:'-'}}</td>
                        <td>{{company.volume|default:'-'}}</td>
                        <td class="positive">{{company.fifty_two_week_high|default:'-'}}</td>
                        <td class="negative">{{company.fifty_two_week_low|default:'-'}}</td>
                        <td>{{company.sector|default:'N/A'}}</td>
                        <td>
                            <button class="ti-btn ti-btn-sm ti-btn-primary" onclick="viewProfile('{{company.symbol}}')">
                                View
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="pagination" id="pagination">
            <!-- Pagination buttons will be generated by JavaScript -->
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Global variables
let allData = [];
let filteredData = [];
let currentPage = 1;
const itemsPerPage = 10;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadTableData();
    setupEventListeners();
    updateStatistics();
});

function loadTableData() {
    const rows = document.querySelectorAll('#table-body tr');
    allData = Array.from(rows).map(row => ({
        symbol: row.dataset.symbol,
        name: row.cells[1].textContent,
        marketCap: row.cells[2].textContent,
        peRatio: row.cells[3].textContent,
        volume: row.cells[4].textContent,
        high52w: row.cells[5].textContent,
        low52w: row.cells[6].textContent,
        sector: row.dataset.sector,
        element: row
    }));
    
    filteredData = [...allData];
    populateSectorFilter();
    renderTable();
}

function populateSectorFilter() {
    const sectors = [...new Set(allData.map(item => item.sector).filter(s => s && s !== 'N/A'))];
    const sectorFilter = document.getElementById('sector-filter');
    
    sectors.forEach(sector => {
        const option = document.createElement('option');
        option.value = sector;
        option.textContent = sector;
        sectorFilter.appendChild(option);
    });
}

function setupEventListeners() {
    // Search functionality
    document.getElementById('search-input').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        filteredData = allData.filter(item => 
            item.symbol.toLowerCase().includes(searchTerm) ||
            item.name.toLowerCase().includes(searchTerm)
        );
        currentPage = 1;
        renderTable();
    });
    
    // Sector filter
    document.getElementById('sector-filter').addEventListener('change', function(e) {
        const selectedSector = e.target.value;
        if (selectedSector) {
            filteredData = allData.filter(item => item.sector === selectedSector);
        } else {
            filteredData = [...allData];
        }
        currentPage = 1;
        renderTable();
    });
    
    // Sort functionality
    document.getElementById('sort-select').addEventListener('change', function(e) {
        const sortBy = e.target.value;
        sortData(sortBy);
        renderTable();
    });
}

function sortData(sortBy) {
    filteredData.sort((a, b) => {
        switch(sortBy) {
            case 'symbol':
                return a.symbol.localeCompare(b.symbol);
            case 'marketCap':
                return parseFloat(a.marketCap.replace(/[^\d.-]/g, '')) - parseFloat(b.marketCap.replace(/[^\d.-]/g, ''));
            case 'pe':
                return parseFloat(a.peRatio) - parseFloat(b.peRatio);
            case 'volume':
                return parseFloat(a.volume.replace(/[^\d.-]/g, '')) - parseFloat(b.volume.replace(/[^\d.-]/g, ''));
            default:
                return 0;
        }
    });
}

function renderTable() {
    const tbody = document.getElementById('table-body');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageData = filteredData.slice(startIndex, endIndex);
    
    // Hide all rows
    allData.forEach(item => item.element.style.display = 'none');
    
    // Show filtered rows
    pageData.forEach(item => item.element.style.display = '');
    
    renderPagination();
}

function renderPagination() {
    const totalPages = Math.ceil(filteredData.length / itemsPerPage);
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Previous button
    const prevBtn = document.createElement('button');
    prevBtn.textContent = '‚Üê Previous';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => changePage(currentPage - 1);
    pagination.appendChild(prevBtn);
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            const pageBtn = document.createElement('button');
            pageBtn.textContent = i;
            pageBtn.className = i === currentPage ? 'active' : '';
            pageBtn.onclick = () => changePage(i);
            pagination.appendChild(pageBtn);
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            const dots = document.createElement('span');
            dots.textContent = '...';
            dots.style.padding = '8px';
            pagination.appendChild(dots);
        }
    }
    
    // Next button
    const nextBtn = document.createElement('button');
    nextBtn.textContent = 'Next ‚Üí';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => changePage(currentPage + 1);
    pagination.appendChild(nextBtn);
}

function changePage(page) {
    const totalPages = Math.ceil(filteredData.length / itemsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderTable();
    }
}

function viewProfile(symbol) {
    window.location.href = `/profile/${symbol}/`;
}

function updateStatistics() {
    // Update total sectors
    const sectors = new Set(allData.map(item => item.sector).filter(s => s && s !== 'N/A'));
    document.getElementById('total-sectors').textContent = sectors.size;
    
    // Calculate averages (placeholder - you might want to fetch real data)
    document.getElementById('avg-market-cap').textContent = '‚Ç∫2.5B';
    document.getElementById('avg-pe').textContent = '12.4';
}

function downloadCSV() {
    const csvContent = "data:text/csv;charset=utf-8," 
        + "Symbol,Company Name,Market Cap,P/E Ratio,Volume,52W High,52W Low,Sector\n"
        + filteredData.map(item => 
            `${item.symbol},"${item.name}",${item.marketCap},${item.peRatio},${item.volume},${item.high52w},${item.low52w},${item.sector}`
        ).join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "financial_data.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function downloadJSON() {
    const jsonContent = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(filteredData, null, 2));
    const link = document.createElement("a");
    link.setAttribute("href", jsonContent);
    link.setAttribute("download", "financial_data.json");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function printTable() {
    window.print();
}

// Add some animations
document.addEventListener('DOMContentLoaded', function() {
    // Fade in table rows
    setTimeout(() => {
        const rows = document.querySelectorAll('#table-body tr');
        rows.forEach((row, index) => {
            setTimeout(() => {
                row.style.opacity = '0';
                row.style.transform = 'translateY(20px)';
                row.style.transition = 'all 0.3s ease';
                
                setTimeout(() => {
                    row.style.opacity = '1';
                    row.style.transform = 'translateY(0)';
                }, index * 50);
            }, 100);
        });
    }, 200);
});
</script>
{% endblock %}
